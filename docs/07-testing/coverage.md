# Coverage Report (Покрытие кода тестами)

Проект: **InvestCalc — Инвестиционный аналитик ИС**  
Версия: 1.0  
Дата: `<указать>`

---

## 1. Назначение документа

Этот документ фиксирует результаты измерения **покрытия кода тестами** (Code Coverage), полученные во время запуска CI или локального тестирования.

Coverage используется для оценки:

- полноты тестового покрытия модулей,
- качества тестов,
- наличия "серых зон" в коде (непокрытых веток и функций),
- уровня риска регрессий.

---

## 2. Как выполняется измерение покрытия

Покрытие считается с помощью инструмента:

```

pytest --cov=src --cov-report=xml --cov-report=term-missing

```

Генерируются:

- `coverage.xml` — XML-отчёт для CI/CD или Codecov
- консольный отчёт (таблица по модулям)
- детальный отчёт по строкам (term-missing)

---

## 3. Общая сводка покрытия

> Ниже приведён шаблон итоговой статистики.  
> Настоящие значения подставляются после выполнения тестов.

| Модуль | Покрытие (%) | Строк всего | Пропущено | Комментарий |
|--------|--------------|--------------|------------|-------------|
| `src/services/invest_service.py` | `<XX>%` | `<N>` | `<N>` | Основная бизнес-логика |
| `src/api/v1/routes_invest.py` | `<XX>%` | `<N>` | `<N>` | API-слой |
| `src/models/invest.py` | `<XX>%` | `<N>` | `<0>` или `<N>` | Модели |
| `src/core/config.py` | `<XX>%` | `<N>` | `<0>` | Конфигурация |
| **Итого** | **`<TOTAL>%`** | `<TOTAL_LINES>` | `<TOTAL_MISSED>` | — |

---

## 4. Пример реального отчёта (образец)

```

---------- coverage: platform linux, python 3.11 ----------
Name                                   Stmts   Miss  Cover
----------------------------------------------------------

src/services/invest_service.py           185      8    96%
src/api/v1/routes_invest.py               75      4    94%
src/models/invest.py                      42      0   100%
src/core/config.py                        18      0   100%
----------------------------------------------------------

TOTAL                                    320     12    96%

```

---

## 5. Покрытие по важнейшим модулям

### 5.1. Бизнес-логика (`invest_service.py`)

**Ключевые зоны:**  
- расчёт TCO  
- расчёт ROI  
- логика Payback  
- анализ чувствительности  
- операции со сценариями  
- работа с JSON-хранилищем  

**Цель покрытия:**  
≥ 90%

### 5.2. API-слой (`routes_invest.py`)

Покрываются:

- коды ответов,
- преобразование исключений,
- маршруты `/calc`, `/sensitivity`, `/scenarios`.

**Цель покрытия:**  
≥ 85–90%

### 5.3. Модели (`models/invest.py`)

Покрытие обычно близко к 100%, так как:

- полевая валидация проверяется через API,
- модели используются во всех тестах.

---

## 6. Покрытие веток (branch coverage)

При необходимости можно запускать:

```

pytest --cov=src --cov-branch

```

Branch-coverage позволяет обнаружить:

- неиспользуемые ветки,
- условные конструкции типа `if/else`,
- редкие кейсы Payback, где проект не окупается,
- ветки обработки ошибок JSON.

---

## 7. Анализ пропущенных строк (term-missing)

Пример формата:

```

src/services/invest_service.py     96%   (missing lines: 141, 208, 309, 350)

```

### Типичные причины непокрытых строк:

- редкие ошибки файловой системы,
- логирование в edge-cases,
- сообщения о невозможности окупаемости,
- проверки вроде `if param not in base_input_dict`.

Для повышения покрытия можно:

- написать отдельные тесты для негативных сценариев,
- использовать фикстуры pytest для мокирования файловой системы,
- проверять ValueError в edge-кейсах.

---

## 8. Требования к покрытию по проекту

### Минимальный уровень покрытия:

| Слой | Требование |
|------|------------|
| Бизнес-логика | ≥ 90% |
| API | ≥ 85% |
| Модели | 100% |
| Конфигурация | ≥ 90% |
| Общий уровень | ≥ 90% |

Эти требования соответствуют:

- промышленным практикам (Python backend),
- стандартам учебных проектов (СПО).

---

## 9. Включение Coverage в CI/CD

Coverage сохраняется как артефакт CI:

```

coverage.xml
pytest-report.txt

```

Если используется Codecov:

```

* name: Upload coverage to Codecov
  uses: codecov/codecov-action@v3

```

В отчёте отображаются:

- тренды покрытия,
- файлы с падением уровня покрытия,
- PR-дельта покрытия.

---

## 10. Рекомендации по улучшению покрытия

1. **Добавить тесты для ошибок JSON-хранилища**
   - повреждённый файл,
   - отсутствие каталога,
   - ошибка записи.

2. **Тесты на невозможность окупаемости**
   - `monthly_cash_flow <= 0`.

3. **Тесты на extreme-values**
   - CAPEX = 0,
   - effects = 0,
   - TCO = 0 → ROI = 999.99.

4. **Разделение тестов чувствительности по параметрам**
   - CAPEX-, CAPEX+,
   - OPEX-, OPEX+,
   - Effects-, Effects+.

5. **Проверка сортировки сценариев по дате**  

6. **Покрытие 404 / 500 ошибок API**

---

## 11. Связанные документы

- `ci-test-report.md`  
- `test-plan.md`  
- `test-cases.md`  
- `test-environment.md`  
- `test-strategy.md`  
- `../08-DEVOPS/ci-cd-pipeline.md`  

 