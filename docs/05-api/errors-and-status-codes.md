# Errors and Status Codes — Ошибки и коды ответов API InvestCalc

Документ описывает:

- какие коды HTTP-ответов использует API InvestCalc;
- формат ошибок;
- типичные ситуации для каждой ошибки;
- матрицу «эндпоинт → коды».

Этот файл дополняет:

- `api-overview.md`
- `endpoints-invest.md`
- `security.md`

---

## 1. Общий формат ответа об ошибке

Все ошибки (кроме стандартных ошибок валидации FastAPI/Pydantic) должны возвращаться в **единым JSON-формате**:

```json
{
  "error": "Краткое описание ошибки",
  "details": [
    {
      "loc": ["field_name"],
      "msg": "Сообщение об ошибке"
    }
  ]
}
```

Пояснения:

* `error` — короткое название/тип ошибки (например, `"Invalid input"`, `"Business rule violation"`).
* `details` — массив объектов с дополнительной информацией:

  * `loc` — расположение ошибки: поле входной модели, параметр запроса и т.п.;
  * `msg` — человекочитаемое сообщение.

Для ошибок валидации FastAPI/Pydantic может использовать собственный формат (обычный ответ `422 Unprocessable Entity`). Это допустимо и считается частью стандартного поведения фреймворка.

---

## 2. Используемые HTTP-коды

В InvestCalc используются следующие коды:

| Код | Название                | Использование                            |
| --- | ----------------------- | ---------------------------------------- |
| 200 | OK                      | Успешная обработка запроса               |
| 201 | Created *(опционально)* | Не используется в базовой версии         |
| 400 | Bad Request             | Ошибка данных по бизнес-правилам         |
| 404 | Not Found               | Ресурс не найден (сценарий, файл и т.п.) |
| 422 | Unprocessable Entity    | Ошибка схемы / валидации входных данных  |
| 500 | Internal Server Error   | Непредвиденная ошибка сервера            |

При необходимости в расширенной версии можно добавить:

* `401 Unauthorized` — при появлении аутентификации;
* `403 Forbidden` — при ограничении доступа;
* `409 Conflict` — при конфликте ресурсов.

---

## 3. Общие правила возврата ошибок

1. **Ошибки валидации входных данных (тип/структура)**
   → `422 Unprocessable Entity`
   Возвращаются автоматически FastAPI/Pydantic или оборачиваются в единый формат.

2. **Ошибки бизнес-логики** (например, «период анализа не может быть 0», «проект не окупается, но ожидается окупаемость»)
   → `400 Bad Request`
   Сообщение должно подробно объяснять причину.

3. **Отсутствующий ресурс** (например, указанный JSON-файл сценария не найден)
   → `404 Not Found`

4. **Непредвиденная ошибка сервера** (исключения, которые не обработаны явно)
   → `500 Internal Server Error`

---

## 4. Матрица ошибок по эндпоинтам

### 4.1. `POST /api/v1/calculate`

**Назначение:** базовый расчёт экономических показателей.

**Коды:**

| Код | Когда возникает                                    | Пример причины                                                               |
| --- | -------------------------------------------------- | ---------------------------------------------------------------------------- |
| 200 | Успешный расчёт                                    | Корректные входные данные                                                    |
| 400 | Нарушены бизнес-правила                            | `period < 1`, логика окупаемости не может быть рассчитана в ожидаемом режиме |
| 422 | Ошибки валидации (тип, формат, отсутствующие поля) | `capex` — строка вместо числа, пропущен `effect`                             |
| 500 | Непредвиденная ошибка сервера                      | Деление на ноль, ошибка в коде расчёта, баг                                  |

**Примеры ошибок:**

* **422 Unprocessable Entity**

  ```json
  {
    "detail": [
      {
        "loc": ["body", "capex"],
        "msg": "value is not a valid float",
        "type": "type_error.float"
      }
    ]
  }
  ```

* **400 Bad Request (бизнес-правило)**

  ```json
  {
    "error": "Invalid input",
    "details": [
      {
        "loc": ["period"],
        "msg": "Period must be >= 1 year"
      }
    ]
  }
  ```

---

### 4.2. `POST /api/v1/sensitivity`

**Назначение:** анализ чувствительности ±delta% к базовым значениям.

**Коды:**

| Код | Когда возникает                             | Пример причины                                                             |
| --- | ------------------------------------------- | -------------------------------------------------------------------------- |
| 200 | Успешная генерация матрицы чувствительности | Данные валидны                                                             |
| 400 | Бизнес-ошибка в параметрах                  | Например, `delta_percent` вне допустимого диапазона (в расширенной версии) |
| 422 | Ошибки валидации тела запроса               | Отрицательные или неверные типы для `capex`, `opex`                        |
| 500 | Ошибка в логике анализа                     | Непредвиденное исключение                                                  |

**Пример 422:**

```json
{
  "detail": [
    {
      "loc": ["body", "capex"],
      "msg": "value must be greater than or equal to 0",
      "type": "value_error.number.not_ge"
    }
  ]
}
```

**Пример 400 (расширенная бизнес-логика):**

```json
{
  "error": "Business rule violation",
  "details": [
    {
      "loc": ["delta_percent"],
      "msg": "Delta must be between 0 and 100"
    }
  ]
}
```

---

### 4.3. `GET /api/v1/compare`

**Назначение:** сравнение двух сценариев (обычно `local` и `cloud`), зачастую через загрузку JSON из `data/`.

**Коды:**

| Код | Когда возникает                                    | Пример причины                          |
| --- | -------------------------------------------------- | --------------------------------------- |
| 200 | Оба сценария успешно прочитаны и сравнены          | Файлы есть, структура корректна         |
| 400 | Сценарии не могут быть сравнены по бизнес-правилам | Например, несовместимые периоды анализа |
| 404 | Сценарий/файл не найден                            | Файл `input-local.json` отсутствует     |
| 422 | Неверный формат параметров запроса                 | Некорректные query-параметры            |
| 500 | Ошибка при чтении файлов или в логике сравнения    | Исключение при парсинге JSON            |

**Примеры:**

* **404 Not Found (файл сценария)**

  ```json
  {
    "error": "Scenario not found",
    "details": [
      {
        "loc": ["query", "local"],
        "msg": "File input-local.json does not exist"
      }
    ]
  }
  ```

* **400 Bad Request (несовместимость сценариев)**

  ```json
  {
    "error": "Cannot compare scenarios",
    "details": [
      {
        "loc": ["query"],
        "msg": "Scenarios must have the same analysis period"
      }
    ]
  }
  ```

---

### 4.4. `GET /api/v1/report`

**Назначение:** генерация HTML-отчёта по расчётам.

**Коды:**

| Код | Когда возникает                                 | Пример причины                                   |
| --- | ----------------------------------------------- | ------------------------------------------------ |
| 200 | Успешная генерация отчёта                       | Все промежуточные операции прошли успешно        |
| 400 | Недостаточно данных для отчёта (если требуется) | Сценарий не задан, результат расчёта отсутствует |
| 500 | Ошибка при генерации отчёта                     | Исключение при рендеринге шаблона                |

**Пример 500:**

```json
{
  "error": "Report generation error",
  "details": [
    {
      "loc": ["internal"],
      "msg": "Template not found or invalid"
    }
  ]
}
```

*(В текущей простой версии любую проблему при генерации отчёта можно оборачивать в 500.)*

---

### 4.5. `GET /api/v1/health`

**Назначение:** проверка живости сервиса.

**Коды:**

| Код | Когда возникает                          | Пример причины                 |
| --- | ---------------------------------------- | ------------------------------ |
| 200 | Сервис в рабочем состоянии               | Всё ок                         |
| 500 | Критическая ошибка инициализации сервиса | Непредвиденная проблема старта |

На практике:

* в учебной версии почти всегда возвращается `200 OK` с `{ "status": "ok" }`;
* в расширенной версии можно добавлять более сложную диагностику (проверка БД, файлов и т.д.).

---

## 5. Коды и ошибки бизнес-правил

Чтобы связать тесты, бизнес-правила и ошибки, рекомендуется:

* в `business-rules.md` явно описать, какие правила дают **400 Bad Request**, а какие просто влияют на значение полей (`is_profitable = false`, `payback = null`);
* в тестах (`test_service.py`, `test_api.py`) проверять:

  * корректный набор кодов;
  * содержимое `error` и `details`.

Пример привязки:

| Business Rule ID | Описание                                  | Реакция API                  |
| ---------------- | ----------------------------------------- | ---------------------------- |
| BR-01            | Period ≥ 1 год                            | 400 + сообщение              |
| BR-02            | CAPEX/OPEX/EFFECT ≥ 0                     | 422 или 400 (по решению)     |
| BR-03            | Если проект не окупается → payback = null | 200, логика в ответе         |
| BR-08            | При равном ROI сравнение по TCO           | 200, бизнес-логика в compare |

---

## 6. Рекомендации по реализации в коде

1. Использовать **единый helper** для ошибок бизнес-логики, например:

   ```python
   from fastapi import HTTPException

   def bad_request_error(msg: str, loc: list[str] | None = None):
       raise HTTPException(
           status_code=400,
           detail={
               "error": "Business rule violation",
               "details": [{"loc": loc or [], "msg": msg}]
           }
       )
   ```

2. Глобальный обработчик для неожиданных ошибок (`500`):

   * логировать исключение;
   * возвращать «чистое» сообщение пользователю:

     ```json
     { "error": "Internal server error" }
     ```

3. Для ошибок валидации полагаться на стандартный 422 FastAPI / Pydantic.
