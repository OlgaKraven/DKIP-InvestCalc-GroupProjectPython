# API Versioning — Версионирование API в InvestCalc

Документ описывает стратегию версионирования API InvestCalc, принципы 
поддержки нескольких версий, правила изменения контрактов, а также рекомендации 
по расширению API в будущих релизах.

Этот файл дополняет:

- `api-overview.md`
- `endpoints-invest.md`
- `errors-and-status-codes.md`
- архитектурную документацию в папке `03-architecture/`

---

## 1. Зачем нужно версионирование API

Даже в учебном проекте жизненный цикл API включает изменения:

- добавление новых параметров;
- расширение расчётов;
- изменение бизнес-логики;
- исправления ошибок, влияющих на контракт API;
- добавление новых форматов отчётов;
- расширение анализа чувствительности.

Версионирование позволяет:

- вносить изменения **без нарушения работы существующих клиентов**;
- поддерживать стабильный контракт API для тех, кто уже использует старые версии;
- документировать эволюцию сервиса.

---

## 2. Стратегия версионирования InvestCalc

Используется **URI-based версионирование** (наиболее понятное для студентов):

```

/api/v1/calculate
/api/v1/sensitivity
/api/v1/compare
/api/v1/report

```

Префикс задаётся в конфигурации:

```python
api_v1_prefix: str = "/api/v1"
```

---

## 3. Правила изменения версии

### 3.1. Что требует перехода на новую версию (v2)

Если изменения нарушают **обратную совместимость**, необходимо создать `/api/v2`.

Примеры изменений, которые требуют новой major-версии:

* изменение формата входной модели (`InvestmentInput`);
* удаление полей из JSON-ответа;
* изменение семантики расчёта (например, новая формула ROI);
* изменение типов данных;
* переименование эндпоинтов;
* добавление обязательных полей.

### 3.2. Что можно добавлять в v1 без изменения версии

Если изменения **совместимы**, версия остаётся прежней.

Разрешено:

* добавлять новые поля, которые **не обязательные**;
* добавлять новые эндпоинты;
* добавлять новые параметры в query с параметрами по умолчанию;
* расширять модель ответа дополнительной информацией.

---

## 4. Структура каталогов и кода при нескольких версиях

Если появится API v2, структура будет выглядеть так:

```
src/api/
│
├── v1/
│   ├── routes_invest.py
│   ├── models_v1.py (опционально)
│   └── ...
│
└── v2/
    ├── routes_invest.py
    ├── models_v2.py
    └── ...
```

FastAPI позволяет подключать их параллельно:

```python
app.include_router(v1_router, prefix="/api/v1")
app.include_router(v2_router, prefix="/api/v2")
```

---

## 5. Обязательная документация для новой версии

Каждая новая версия **должна иметь собственные файлы документации**:

```
docs/05-api/api-overview.md
docs/05-api/endpoints-invest-v2.md
docs/05-api/openapi-link-v2.md
```

Причины:

* версии API часто расходятся по структуре запросов/ответов;
* документация не должна смешивать v1 и v2;
* Swagger генерирует отдельный OpenAPI для каждой версии.

---

## 6. Поддержка нескольких версий одновременно

Если в проекте появится v2, то v1 не удаляется сразу.

Рекомендации:

| Версия | Статус            | Описание                                  |
| ------ | ----------------- | ----------------------------------------- |
| v1     | Active/Deprecated | Работает, исправляются критические ошибки |
| v2     | Active            | Разработка новых функций                  |

Типичный учебный цикл:

* **v1** — стабильная базовая версия
* **v2** — расширенная версия (дополнительные параметры, новая модель расчётов)

---

## 7. Политика деприкации

Если версия устаревает, необходимо:

1. добавить предупреждение в `/api/v1/health`:

```json
{
  "status": "ok",
  "deprecated": true,
  "message": "Use /api/v2 instead"
}
```

2. добавить пометку в Swagger:

```python
tags_metadata = [
    {
        "name": "v1",
        "description": "Версия устарела. Используйте /api/v2."
    }
]
```

3. обновить документацию:

```
docs/05-api/v1-deprecation.md
```

---

## 8. Версионирование OpenAPI-спецификаций

Каждая версия API имеет собственный OpenAPI:

```
/api/v1/openapi.json
/api/v2/openapi.json
```

И в Swagger UI версии могут отображаться как отдельные секции.

---

## 9. Версионирование моделей данных

Если в v2 требуется расширить модели:

* `InvestmentInput_v2`
* `CalcResult_v2`
* `SensitivityResult_v2`

То их нужно положить в:

```
src/models/v2/
```

И **ни в коем случае не менять модели v1**, иначе нарушится совместимость.

---

## 10. Примеры изменений, которые могут появиться в v2 InvestCalc

### Пример 1 — новый параметр discount_rate

Учебная расширенная версия может добавить:

```
discount_rate: float = 0.12
```

Это меняет формулы (`NPV`, `IRR`) → требуется **v2**.

### Пример 2 — расширенная чувствительность

Вместо базовых ±20%, v2 может позволить:

* пользовательский диапазон,
* многофакторную чувствительность (двумерную матрицу).

### Пример 3 — многолетние сценарии (массивы CAPEX/OPEX)

Это кардинальное изменение модели. Требуется **v2**.

