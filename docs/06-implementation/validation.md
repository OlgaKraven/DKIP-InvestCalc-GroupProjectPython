# Валидация данных (Validation)

Проект: **InvestCalc — Инвестиционный аналитик ИС**  
Версия: 1.0  
Дата: `<указать>`

---

## 1. Назначение документа

Документ описывает систему *валидации данных* в InvestCalc:

- какие проверки выполняются на уровне входящих HTTP-запросов;
- как работает валидация Pydantic-моделей;
- какие бизнес-правила контролируются вручную;
- как ошибки преобразуются в HTTP-ответы.

Цель — гарантировать корректность входных данных и предсказуемость работы сервисов.

---

## 2. Общий подход к валидации

Валидация реализована на трёх уровнях:

### 1) **Синтаксическая валидация (Pydantic)**  
Проверяет структуру данных, типы, обязательные поля, форматы.

### 2) **Бизнес-валидация (Python, вручную)**  
Проверяет бизнес-ограничения:  
- CAPEX/OPEX/effects ≥ 0,  
- `period_months > 0`,  
- `delta_percent > 0`,  
- список `parameters` не пуст,  
- сценарий имеет id при обновлении и т.д.

### 3) **Слой HTTP (FastAPI)**  
Конвертирует ошибки валидации в корректные **HTTP-коды**:

- Ошибки Pydantic → **422 Unprocessable Entity**  
- Ошибки бизнес-логики (`ValueError`) → **422**  
- Отсутствие сценария → **404**  
- Ошибки файловой системы → **500**

---

## 3. Валидация через Pydantic (структура + типы)

Все входные данные API описаны через Pydantic-модели:

- `InvestInput`  
- `SensitivityRequest`  
- `ScenarioDetail`  
- `ScenarioShort`  
- `ScenarioItem`  

При получении запроса FastAPI:

1. Парсит JSON в модель.
2. Выполняет статическую проверку типов.
3. Проверяет обязательные поля.
4. При ошибке сразу возвращает:

```json
{
  "detail": [
    {
      "loc": ["body", "capex"],
      "msg": "value is not a valid float",
      "type": "type_error.float"
    }
  ]
}
```

HTTP-код: **422 Unprocessable Entity**

### Пример ошибок структуры:

| Поле                                     | Ошибка                        | Реакция |
| ---------------------------------------- | ----------------------------- | ------- |
| `capex` = `"abc"`                        | некорректный тип              | 422     |
| отсутствует `period_months`              | отсутствует обязательное поле | 422     |
| `effects = null` (если поле обязательно) | недопустимое значение         | 422     |

---

## 4. Бизнес-валидация (в `services/invest_service.py`)

Pydantic проверяет структуру, но НЕ знает доменных правил.

Поэтому перед выполнением расчётов вручную выполняются бизнес-проверки.

### 4.1. Проверка входных данных расчёта

```python
if input_data.capex < 0 or input_data.opex < 0 or input_data.effects < 0:
    raise ValueError("CAPEX, OPEX и эффекты не могут быть отрицательными.")

if input_data.period_months <= 0:
    raise ValueError("Период анализа (period_months) должен быть больше нуля.")
```

### 4.2. Проверка запроса чувствительности

```python
if request.delta_percent <= 0:
    raise ValueError("delta_percent должен быть больше 0.")

if not request.parameters:
    raise ValueError("Не указан ни один параметр для анализа чувствительности.")
```

### 4.3. Проверка сценариев

При чтении/записи:

* гарантия, что JSON структурно корректен;
* проверка на существование идентификатора;
* отсев невалидных записей при загрузке.

---

## 5. Валидация данных при работе со сценариями

В JSON-файле могут появляться некорректные данные (ручное редактирование, повреждение файлов).
Поэтому при загрузке:

```python
parsed = ScenarioDetail.model_validate(item)
```

Если ошибка → запись пропускается.

Пример:

* отсутствует ключ `"input"` → запись пропускается;
* ошибка формата даты → запись пропускается;
* неверный формат `last_result` → запись пропускается.

---

## 6. Особые случаи и дополнительные проверки

## 6.1. TCO = 0 → особая обработка ROI

```python
if tco == 0:
    if input_data.effects > 0:
        return 999.99   ## условная "очень высокая" доходность
    return 0.0
```

Это **учебное допущение**, задокументированное в бизнес-логике.

## 6.2. PaybackPeriod невозможен

Если ежемесячный денежный поток ≤ 0:

```python
return None, None, "Проект не окупается в рамках заданного периода..."
```

Выходная модель допускает отсутствие значений.

## 6.3. Неверный параметр чувствительности

Если параметр отсутствует в модели:

```python
if param not in base_input_dict:
    continue   ## игнорируем
```

---

## 7. Валидация в HTTP-слое (FastAPI)

Каждый эндпоинт перехватывает `ValueError`, генерируемую бизнес-логикой.

## Пример:

```python
except ValueError as exc:
    raise HTTPException(
        status_code=status.HTTP_422_UNPROCESSABLE_ENTITY,
        detail=str(exc),
    ) from exc
```

Так мы получаем единый формат ошибок:

```json
{
  "detail": "Период анализа (period_months) должен быть больше нуля."
}
```

---

## 8. Валидация на уровне файловой системы

Ошибки работы с JSON-файлом:

* отсутствует каталог `/data`,
* нет прав доступа,
* повреждён JSON,
* ошибка при записи.

Перехватываются как:

```python
except OSError as exc:
    raise HTTPException(500, f"Failed to save scenario: {exc}")
```

---

## 9. Таблица всех проверок в InvestCalc

### 9.1. Проверки входных данных (Pydantic)

| Поле            | Тип       | Требование | Поведение                            |
| --------------- | --------- | ---------- | ------------------------------------ |
| `capex`         | float     | обяз.      | ошибка 422 если не число             |
| `opex`          | float     | обяз.      | ошибка 422 если не число             |
| `effects`       | float     | обяз.      | ошибка 422 если не число             |
| `period_months` | int       | обяз.      | ошибка 422 если нет или неверный тип |
| `parameters`    | List[str] | обяз.      | ошибка 422 если нет массива          |
| `delta_percent` | float     | обяз.      | 422 если null/нет                    |

---

### 9.2. Проверки бизнес-логики

| Правило                              | Если нарушено                    | Реакция  |
| ------------------------------------ | -------------------------------- | -------- |
| CAPEX ≥ 0                            | `ValueError`                     | HTTP 422 |
| OPEX ≥ 0                             | `ValueError`                     | HTTP 422 |
| effects ≥ 0                          | `ValueError`                     | HTTP 422 |
| period_months > 0                    | `ValueError`                     | HTTP 422 |
| delta_percent > 0                    | `ValueError`                     | HTTP 422 |
| parameters не пуст                   | `ValueError`                     | HTTP 422 |
| параметр чувствительности существует | параметр игнорируется            | 200      |
| JSON повреждён                       | запись пропускается / ошибка 500 | HTTP 500 |

---

## 10. Рекомендации по расширению валидации

### Возможные улучшения:

1. Ввести `Field(gt=0)` и `Field(ge=0)` в Pydantic-модели:

   ```python
   capex: float = Field(ge=0)
   period_months: int = Field(gt=0)
   ```
2. Добавить строгие схемы JSON Schema для Swagger/OpenAPI.
3. Ввести валидацию на “разумность” полей:

   * `capex < 1_000_000_000`,
   * `period_months ≤ 600` (50 лет).
4. Добавить валидацию зависимых полей:

   * например, `effects > opex` для проектов с окупаемостью.

---

## 11. Связанные документы

* `docs/06-implementation/error-handling.md`
* `docs/06-implementation/business-logic.md`
* `docs/06-implementation/api-internal.md`
* `docs/06-implementation/data-access.md`
* `docs/05-api/errors-and-status-codes.md`
* `docs/03-architecture/adr-*.md`

 