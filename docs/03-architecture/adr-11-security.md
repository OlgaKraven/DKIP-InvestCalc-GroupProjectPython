# ADR-11 — Безопасность API и обработка входных данных

Дата: 2025-01-01  
Статус: В работе

---

## 1. Контекст

InvestCalc — это REST API-сервис, который:

- принимает данные от пользователей,
- выполняет математические операции,
- формирует отчёты,
- может быть опубликован публично (Docker, GitHub Pages → API нельзя разместить там) или внутри учебной сети.

Так как система принимает числовые данные, входящие JSON-структуры и сценарии из файлов, необходимо гарантировать:

- безопасность валидации,
- предсказуемость поведения API,
- защиту от некорректных запросов,
- отсутствие возможности выполнить вредоносный код,
- устойчивость сервиса под нагрузкой.

В отличие от коммерческих систем, проект учебный, но всё равно должен соответствовать базовым требованиям безопасности API.

---

## 2. Решение

Принято решение:

## ✔ Использовать концепцию безопасного API уровня L1-L2 (OWASP API Security Top 10)  
и внедрить следующие меры:

## 1) **Строгая валидация всех входных данных через Pydantic (см. ADR-04)**  
— обязательные поля  
— ограничения типов  
— числовые диапазоны  

## 2) **Stateless-подход (см. ADR-06)**  
Нет хранения пользовательских данных → нет риска утечек.

## 3) **Ограничение размера запросов**  
— FastAPI позволяет установить лимиты на размер JSON.

## 4) **Обработка ошибок с безопасными сообщениями**  
— исключить возврат traceback пользователям.

## 5) **Отсутствие пользовательских файлов как input**  
— только JSON → снижает риски.

## 6) **Ограничение путей доступа к файловой системе**  
— загрузка сценариев только из `data/`.

## 7) **HTTP-методы только необходимые (GET/POST)**  
— нет PUT/PATCH/DELETE → минимизация ата surface.

## 8) **Защита от DoS (на уровне Uvicorn)**  
— можно включить ограничения воркеров и timeout.

---

## 3. Обоснование

## 3.1. Уровень угроз небольшого учебного API минимален
Но ошибки безопасности всё равно могут привести к:
- отказу API,
- некорректным вычислениям,
- загрузке неправильных сценариев,
- нарушению работы всего сервера.

## 3.2. Pydantic закрывает большинство рисков
Так как сервис принимает структурированные данные:
- Pydantic отбрасывает всё лишнее,
- типизирует значения,
- блокирует опасные JSON.

## 3.3. Stateless делает API почти непробиваемым
Нет:
- сессий,
- токенов,
- пользователей,
- cookie,
- CSRF.

## 3.4. Минимизация API-поверхности
Оставляем только 3 эндпоинта:
- `/calculate`
- `/sensitivity`
- `/report`

Это уменьшает потенциальные точки атаки.

## 3.5. Безопасность DevOps (Docker)
В рамках DevOps (см. ADR-02 и ADR-09) предусмотрено:

- ограничение прав контейнера,
- отсутствие root-доступа,
- использование slim-образов.

---

## 4. Альтернативы

## 4.1. Полноценная авторизация/аутентификация
**Отклонено**
Причины:
- нет пользователей,
- нет личного кабинета,
- усложняет обучение.

## 4.2. Ограничение IP-адресов
**Отклонено**
Причины:
- требуется сетевой прокси,
- не нужно в учебном проекте.

## 4.3. Использование JWT
**Отклонено**
Причины:
- избыточно,
- нет multi-user функционала.

---

## 5. Последствия

## Положительные:
- API безопасен по умолчанию,
- входные данные строго контролируются,
- отсутствует XSS/SQLi класс атак,
- невозможна передача вредоносных файлов,
- упрощённый DevOps → легко деплоить студентам.

## Негативные:
- при добавлении пользователей придётся обновлять ADR,
- для масштаба предприятия защиты недостаточно.

---

## 6. Реализация в коде

## Пример: безопасная валидация

```python
class InvestmentInput(BaseModel):
    capex: float = Field(ge=0, le=10_000_000)
    opex: float = Field(ge=0)
    period: int = Field(ge=1, le=50)
    effect: float = Field(ge=0)
```

## Пример: обработка ошибок

```python
@app.exception_handler(RequestValidationError)
def validation_exception_handler(request, exc):
    return JSONResponse(
        status_code=400,
        content={"error": "Invalid input", "details": exc.errors()},
    )
```

---

## 7. Связанные ADR

* ADR-01 — Технологический стек
* ADR-04 — Pydantic модели
* ADR-06 — Stateless Architecture
* ADR-10 — Тестирование
* ADR-14 — Путь расширения архитектуры
