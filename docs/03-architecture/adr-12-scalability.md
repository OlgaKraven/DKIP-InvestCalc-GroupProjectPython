# ADR-12 — Масштабирование и контейнеризация

Дата: 2025-01-01  
Статус: Запланировано

---

## 1. Контекст

InvestCalc — учебная информационная система, выполняющая:

- расчёт финансовых показателей,
- анализ чувствительности,
- обработку данных сценариев.

Хотя система учебная, важно предусмотреть возможность:

- работы с большим количеством запросов,
- параллельных пользователей,
- нагрузки во время демонстраций,
- возможного размещения на сервере колледжа,
- развёртывания под Docker.

Стратегия деплоя (см. ADR-02) основана на Docker, что напрямую влияет на масштабируемость.

Требуется определить архитектурный подход к масштабированию.

---

## 2. Решение

Принято решение:

## ✔ Использовать **горизонтальное масштабирование Docker-контейнеров**  
вместо вертикального увеличения ресурсов.

Появляется возможность запускать несколько экземпляров InvestCalc:

```

docker compose up --scale investcalc=3

```

Дополнительно:

## ✔ FastAPI + Uvicorn поддерживают многопроцессную модель  
через параметры:

```

uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4

```

## ✔ Stateless-архитектура (ADR-06) позволяет скейлить без ограничений  
Так как нет состояния → нет необходимости в шеринге памяти или БД.

---

## 3. Обоснование

## 3.1. Docker — идеальная основа для масштабирования
Контейнеры:
- лёгкие,
- одинаковые по окружению,
- быстро поднимаются,
- легко балансируются.

## 3.2. Stateless-подход идеально подходит
Нет необходимости:
- синхронизировать состояния,
- использовать Redis,
- хранить сессии.

Каждый запрос обрабатывается независимо.

## 3.3. Uvicorn поддерживает конкурентность
Uvicorn/ASGI предоставляет:
- асинхронную обработку,
- пул воркеров,
- масштабирование на CPU.

## 3.4. Возможность миграции в Kubernetes
В будущем контейнер можно перенести в:

- Kubernetes,
- Docker Swarm,
- Nomad.

## 3.5. Простота DevOps
Возможность масштабирования одним параметром:

```yaml
services:
  investcalc:
    deploy:
      replicas: 3
```

---

## 4. Альтернативы

## 4.1. Вертикальное масштабирование (добавлять RAM/CPU)

**Отклонено**
Причины:

* хуже предсказуемость,
* дороже,
* не подходит для реальных прод-систем.

## 4.2. Gunicorn + UvicornWorkers (Python WSGI + ASGI mix)

**Отклонено**
Причины:

* не нужен в учебном проекте,
* FastAPI работает быстрее с чистым Uvicorn.

## 4.3. Микросервисная архитектура

**Отклонено сейчас**, возможно в ADR-14.
Причины:

* слишком сложно для учебного проекта,
* нет большого числа подсистем.

---

## 5. Последствия

## Положительные:

* высокая производительность даже под нагрузкой,
* легкое масштабирование,
* удобная работа в Docker,
* возможность использования оркестраторов,
* совместимость с Cloud-платформами.

## Негативные:

* требует понимания DevOps (масштабирование контейнеров),
* отсутствие БД делает невозможным хранение долгосрочных данных.

---

## 6. Пример конфигурации docker-compose для масштабирования

```yaml
services:
  investcalc:
    build: .
    ports:
      - "8000:8000"
    deploy:
      replicas: 3
    environment:
      UVICORN_WORKERS: 4
```

---

## 7. Пример запуска в Uvicorn с несколькими воркерами

```bash
uvicorn src.main:app --host 0.0.0.0 --port 8000 --workers 4
```

---

## 8. Связанные ADR

* ADR-02 — Docker Deployment
* ADR-06 — Stateless Architecture
* ADR-09 — CI/CD
* ADR-14 — План расширения архитектуры

