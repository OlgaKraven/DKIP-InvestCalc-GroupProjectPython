# ADR-10 — Стратегия тестирования (pytest)

Дата: 2025-01-01  
Статус: Принято

---

## 1. Контекст

Проект InvestCalc выполняет:
- расчёт экономических показателей,
- анализ чувствительности,
- сравнение сценариев,
- генерацию отчётов (в дальнейшем),
- валидацию входных данных.

Критично важно обеспечить:
- корректность математических расчётов,
- стабильность API,
- предсказуемость поведения сервиса,
- проверку моделей данных,
- проверку негативных сценариев.

Необходимо выбрать **инструмент тестирования** и **архитектуру тестов**.

---

## 2. Решение

Принято решение использовать:

## ✔ **pytest** в качестве основного тестового фреймворка  
и
## ✔ структурировать тесты по слоям системы:

```

tests/
├── test_api.py
├── test_service.py
└── test_sensitivity.py

```

---

## 3. Обоснование

## 3.1. pytest — простой и мощный инструмент
В отличие от встроенного `unittest`, pytest предоставляет:
- лаконичный синтаксис,
- fixture-механику,
- parametrized tests,
- понятные отчёты об ошибках,
- поддержку плагинов.

## 3.2. Лёгкая интеграция с FastAPI
pytest хорошо работает вместе с:
- TestClient из FastAPI,
- Pydantic моделями,
- моками.

Пример:

```python
from fastapi.testclient import TestClient
from src.main import app
client = TestClient(app)
```

## 3.3. Использование в CI/CD

Pytest стандартно поддерживается GitHub Actions (см. ADR-09).

## 3.4. Простота обучения

Для студентов pytest — наиболее понятный инструмент:

* минимум boilerplate,
* максимум продуктивности.

## 3.5. Полное покрытие бизнес-логики

Pytest позволяет тестировать все уровни:

* API
* Business Logic (сервисный слой)
* модели данных
* чувствительность
* сценарии
* ошибки валидации

---

## 4. Архитектура тестов

## 4.1. test_api.py (интеграционные тесты API)

Проверяется:

* корректный ответ API,
* валидация данных,
* OpenAPI-совместимость,
* ответы на ошибки.

## 4.2. test_service.py (юнит-тесты логики)

Проверяется:

* TCO,
* ROI,
* Payback Period,
* корректность округлений,
* корректность граничных случаев.

## 4.3. test_sensitivity.py (анализ чувствительности)

Проверяется:

* ±20% изменения параметров,
* корректность сравнения сценариев,
* корректность метрик.

---

## 5. Альтернативы

## 5.1. unittest (встроенный модуль Python)

**Отклонено**

Причины:

* громоздкий синтаксис,
* больше boilerplate,
* хуже читаемость для студентов.

## 5.2. nose/nose2

**Отклонено**

Причины:

* устаревшие инструменты.

## 5.3. behave (BDD)

**Отклонено для базовой версии**

Причины:

* слишком сложен,
* требует обучения Gherkin,
* нет необходимости в BDD для учебного проекта.

---

## 6. Последствия

## Положительные:

* высокая надёжность логики,
* возможность регрессионного тестирования,
* интеграция с CI/CD,
* быстрота тестов,
* лёгкость расширения тестовой архитектуры.

## Негативные:

* требует подготовки тестов,
* необходимо писать фикстуры для сложных сценариев.

---

## 7. Пример теста API

```python
def test_calculate_api():
    response = client.post("/api/v1/calculate", json={
        "capex": 1000,
        "opex": 500,
        "period": 5,
        "effect": 2000
    })
    assert response.status_code == 200
    assert "tco" in response.json()
```

---

## 8. Пример теста сервиса

```python
def test_roi_calculation():
    data = InvestmentInput(capex=1000, opex=500, period=5, effect=2000)
    result = calculate_all(data)
    assert result.roi > 0
```

---

## 9. Связанные ADR

* ADR-01 — Технологический стек
* ADR-03 — Структура каталогов
* ADR-04 — Pydantic модели
* ADR-05 — Сервисный слой
* ADR-09 — CI/CD
* ADR-14 — Расширение проекта

---

## 10. Итог

Pytest выбран как стандартный и единственный инструмент тестирования InvestCalc благодаря:

* простоте,
* надёжности,
* гибкости,
* удобной интеграции с FastAPI и Pydantic,
* поддержке GitHub Actions.

Решение считается **окончательно принятым**.

