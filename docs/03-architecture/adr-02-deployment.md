# ADR-02 — Стратегия деплоя и развертывания InvestCalc

**Статус:** Accepted  
**Дата:** 2025-12-02  
**Автор:** Команда InvestCalc  
**Версия:** 1.0

---

## 1. Контекст

Проект **InvestCalc** — легковесный backend-сервис, предоставляющий API для расчёта:

- TCO (Total Cost of Ownership),
- ROI (Return on Investment),
- Payback Period,
- анализа чувствительности,
- управления сценариями (JSON-хранилище).

Требования к развертыванию:

- сервис должен быть простым в управлении, без полноценных БД;
- минимальная инфраструктура;
- возможность локального запуска студентами;
- возможность деплоя на любой хостинг (VPS, Render, Railway, Docker);
- предсказуемое окружение;
- возможность интеграции с CI/CD;
- обеспечение стабильности API и корректной работы с JSON-файлами.

---

## 2. Проблема

Нужно выбрать **подход к развёртыванию**, который:

1. Гарантирует одинаковую среду во всех окружениях.
2. Позволяет деплоить без сложной инфраструктуры.
3. Поддерживает сохранность JSON-датасторов (`/data/scenarios.json`).
4. Является доступным для учащихся и легко воспроизводимым.
5. Позволяет подключить health checks, логи и масштабирование (при необходимости).

---

## 3. Требования к решению

## Функциональные
- Возможность развернуть сервис в 1 команду.
- Поддержка REST API + Swagger UI.
- Корректная работа JSON-хранилища.

## Нефункциональные
- Предсказуемое окружение (Python 3.11).
- Быстрый старт (<10 секунд).
- Лёгкая портируемость.
- Возможность контейнеризации.
- Низкие требования к ресурсам (RAM ≥ 256 МБ).

---

## 4. Принятое решение

## ✔ Использовать **Docker-контейнеризацию** как основной способ деплоя.

Это гарантирует:

- однотипное окружение для всех разработчиков;
- лёгкую установку зависимостей;
- возможность деплоя на любой сервер/хостинг;
- поддержку CI/CD (GitHub Actions → Docker Build → Deploy);
- чёткую изоляцию зависимостей;
- переносимость между ОС.

---

## 5. Детали реализации

## 5.1. Dockerfile

Используется **многостадийный билд** (при необходимости):

- Stage 1: install dependencies  
- Stage 2: run FastAPI with uvicorn

Минимальная версия:

```dockerfile
FROM python:3.11-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .

EXPOSE 8000

CMD ["uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

---

## 5.2. Структура деплоя

 
app
 ├─ src/
 ├─ data/
 │   └─ scenarios.json
 ├─ requirements.txt
 ├─ Dockerfile
 └─ start.sh (опционально)
 

## 5.3. Работа с JSON-хранилищем

* Директория `/data` монтируется как volume.
* Это обеспечивает **сохранение сценариев** между перезапусками контейнера.
* На проде может храниться в `/var/lib/investcalc/data`.

## 5.4. Процесс деплоя

Универсальный деплой на любой сервер:

```
docker build -t investcalc .
docker run -d -p 8000:8000 -v ./data:/app/data investcalc
 

---

## 6. Альтернативы (и почему они отклонены)

## Вариант 1 — Развёртывание напрямую на хост-систему

**Причина отказа:**
Разное окружение → непредсказуемость работы, сложность настройки зависимостей.

---

## Вариант 2 — Использование Kubernetes

**Причина отказа:**
Слишком сложный для учебного проекта стек; избыточно.

---

## Вариант 3 — Серверless (AWS Lambda / GCP Functions)

**Причина отказа:**
Архитектура сервиса не оптимизирована под stateless-модели; JSON-хранилище не подходит под serverless.

---

## Вариант 4 — Render / Railway без контейнера

**Причина отказа:**
Менее предсказуемая зависимость от платформы; возможные различия в окружениях.

---

## 7. Риски и меры снижения

| Риск                                       | Вероятность | Последствия                      | Митигирование                       |
| ------------------------------------------ | ----------- | -------------------------------- | ----------------------------------- |
| Потеря сценариев при обновлении контейнера | средняя     | потеря данных                    | использовать volume                 |
| Ошибка в JSON-файле                        | высокая     | невозможность загрузить сценарии | парсить записи в режиме tolerant    |
| Высокая нагрузка                           | низкая      | задержки                         | горизонтальное масштабирование      |
| Повреждение файла при одновременной записи | средняя     | ошибка 500                       | ввести file-lock (если потребуется) |

---

## 8. Итоговое решение

Проект InvestCalc разворачивается через **Docker-контейнер**, который обеспечивает:

* портируемость,
* предсказуемость,
* поддержку CI/CD,
* простой деплой,
* изоляцию зависимостей,
* независимость от ОС,
* сохранение данных через volume.

Деплой на любые платформы (VPS, Render, Railway) возможен без модификации кода.

**ADR утверждён.**
