# ADR-13 — Логирование и мониторинг в InvestCalc

Дата: 2025-01-01  
Статус: В работе

---

## 1. Контекст

Система InvestCalc является учебным, но технически полноценным REST API, работающим в Docker и поддерживающим CI/CD.  

Для правильной работы сервиса необходимо:

- фиксировать ошибки,
- отслеживать входящие запросы,
- анализировать производительность,
- иметь возможность диагностировать сбои в контейнере,
- собирать минимальные метрики.

В рамках проекта уже существует DevOps-раздел:
```

devops/logging.md
devops/monitoring.md
devops/healthchecks.md

```

Нужно формализовать архитектурное решение о том, **какие механизмы логирования и мониторинга используются**.

---

## 2. Решение

Принято решение внедрить **базовый уровень логирования и мониторинга**, включающий:

## ✔ Логирование уровня INFO/ERROR через стандартный модуль `logging`  
с конфигурацией в:

```

src/core/config.py

```

## ✔ Логирование запросов FastAPI через middleware  
— метод  
— путь  
— статус  
— время ответа  

## ✔ Логирование ошибок (exception handler)  
Все исключения записываются в error-лог.

## ✔ Контейнерный мониторинг  
Docker предоставляет:
- логирование stdout/stderr,
- просмотр логов контейнера,
- переадресацию файлов.

## ✔ Healthchecks (жизнеспособность сервиса)  
В Dockerfile / docker-compose.

## ✔ Мониторинг на уровне CI/CD  
GitHub Actions фиксирует:
- результаты тестов,
- успешность сборки.

---

## 3. Обоснование

## 3.1. Logging — фундаментальный инструмент
Без логов:
- невозможно понять поведение API,
- невозможно анализировать сбои,
- студентам сложнее дебажить.

## 3.2. Встроенный `logging` — простой и надёжный выбор
Преимущества:
- доступен в стандартной библиотеке Python,
- легкая настройка,
- готовая интеграция с FastAPI.

## 3.3. Middleware — лучший способ логировать запросы
FastAPI предоставляет удобный механизм.

## 3.4. Docker логирует всё автоматически
Контейнеры предоставляют:
- единые журналы,
- простую диагностику.

## 3.5. Healthchecks позволяют CI/CD удостовериться, что контейнер жив
Важный элемент DevOps.

---

## 4. Альтернативы

## 4.1. ELK (Elasticsearch + Logstash + Kibana)
**Отклонено (слишком сложная инфраструктура)**

## 4.2. Prometheus + Grafana
**Отклонено как базовое решение**, возможно позже.

## 4.3. Sentry (ошибки)
**Отклонено**
— требует внешнего сервиса.

## 4.4. Loki (логирование в Kubernetes)
**Отклонено**
— не требуется на учебном уровне.

---

## 5. Последствия

## Положительные:
- минимальная, но рабочая система логов,
- простота внедрения,
- студенты легко понимают и развивают код,
- возможность расшириться позже,
- полная интеграция с Docker и CI/CD.

## Негативные:
- нет централизованного хранилища логов,
- нет визуальных дашбордов,
- ограниченная аналитика.

---

## 6. Реализация в коде

## 6.1. Базовый логгер

```python
import logging

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(message)s",
)
logger = logging.getLogger(__name__)
```

## 6.2. Middleware логирования запросов

```python
@app.middleware("http")
async def log_requests(request, call_next):
    logger.info(f"{request.method} {request.url}")
    response = await call_next(request)
    logger.info(f"Status: {response.status_code}")
    return response
```

## 6.3. Обработка ошибок

```python
@app.exception_handler(Exception)
async def global_exception_handler(request, exc):
    logger.error(f"Unhandled error: {exc}")
    return JSONResponse(
        status_code=500,
        content={"error": "Internal Server Error"}
    )
```

---

## 7. Связанные ADR

* ADR-01 — Технологический стек
* ADR-02 — Деплой в Docker
* ADR-06 — Stateless Architecture
* ADR-09 — CI/CD
* ADR-12 — Масштабирование
* ADR-14 — Расширение архитектуры
 
 